<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot</title>
    <!-- <link rel="stylesheet" href="../static/styles.css" /> -->

    <style>
      @keyframes typing {
        from { width: 0; }
        to { width: 100%; }
      }

      @keyframes blink-caret {
        from, to { border-color: transparent; }
        50% { border-color: black; }
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .main-container {
        display: flex;
        width: 100%;
        height: 100vh;
      }

      .chat-container {
        width: 60%;
        height: 100vh;
        background-color: white;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        /* border-radius: 8px; */
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .right-container {
        width: 60%;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      #messages {
        list-style: none;
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
        margin: 0;
      }

      #messages li {
        margin-bottom: 10px;
        border-radius: 20px;
        padding: 10px 20px;
        color: white;
        line-height: 1.4;
        max-width: 80%;
      }

      #messages li.sent {
        background-color: #0b93f6;
        align-self: flex-end;
      }

      #messages li.received {
        background-color: #e5e5ea;
        color: black;
        align-self: flex-start;
      }

      .typing {
        overflow: hidden;
        white-space: nowrap;
      }

      .received {
        white-space: normal;
        word-wrap: break-word;
      }

      form {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
      }

      input[type="text"],
      input[type="file"] {
        flex: 1;
        padding: 10px;
        margin-right: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      button {
        padding: 10px 20px;
        background-color: #0b93f6;
        color: white;
        border: none;
        cursor: pointer;
      }

      .upload-container {
        height: 50%;
        background-color: #f0f0f0;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .history-container {
        height: 50%;
        background-color: #e0e0e0;
        padding: 20px;
        padding-bottom: 10px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        box-sizing: border-box;
      }
      .history-list {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .new-chat-container {
        display: flex;
        justify-content: center;
        padding-top: 10px;
        border-top: 1px solid #ccc;
      }

      #newChatBtn {
        padding: 10px 20px;
        background-color: #0b93f6;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      #newChatBtn:hover {
        background-color: #0a72bc;
      }

      .history-item {
        background-color: white;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .history-item:hover {
        background-color: #d0d0d0;
      }
      
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="chat-container">
        <ul id="messages"></ul>
        <form id="messageForm" onsubmit="sendMessage(event)">
          <input
            type="text"
            id="messageText"
            autocomplete="off"
            placeholder="Type your message..."
          />
          <button type="submit">Send</button>
        </form>
      </div>
      <div class="right-container">
        <div class="upload-container">
          <h2>Upload File</h2>
          <form id="uploadForm">
            <input type="file" id="file" name="file" accept=".csv, .pdf, .xlsx" required />
            <button type="button" onclick="uploadFile()">Upload</button>
          </form>
        </div>
        <div class="history-container" style="border-radius: 15px;">
          <h2>Chat History</h2>
          <ul id="chatHistory" class="history-list">
            <!-- Chat history items will be added here dynamically -->
          </ul>
          <div class="new-chat-container">
            <button id="newChatBtn" onclick="startNewChat()">New Chat</button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      var ws = new WebSocket("ws://127.0.0.1:3939/ws");

      var bgr_url = "";

      var currentChatId = null;
      let chatHistories = {};

      ws.onopen = function () {
        console.log("Connected to the WebSocket server");
        initializeChat();
      };

      ws.onmessage = function (event) {
        receiveMessage(event.data);
      };

      function receiveMessage(message) {
        console.log("Received message:", message);
        if (message.startsWith("Background Image URL")) {
          var bgr_url = message.split("URL: ")[1];
          changeBackgroundImage(bgr_url);
        } else {
          if (!currentChatId) {
            startNewChat();
          }
          addMessageToDisplay(message, "received");
        }
      }

      function sendMessage(event) {
        event.preventDefault();
        var input = document.getElementById("messageText");
        var message = input.value.trim();
        
        if (message) {
          if (!currentChatId) {
            startNewChat();
          }
          ws.send(message);
          addMessageToDisplay(message, "sent");
          input.value = "";
        }
        
        var messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight;
      }

      function addMessageToDisplay(text, type) {
        var messages = document.getElementById("messages");
        var messageElement = document.createElement("li");
        messageElement.classList.add(type);
        messageElement.textContent = text;
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
        
        if (currentChatId) {
          if (!chatHistories[currentChatId]) {
            chatHistories[currentChatId] = [];
          }
          chatHistories[currentChatId].push({type: type, content: text});
        }

        updateChatHistoryEntry();
      }

      function createNewChatHistoryEntry() {
        var chatHistory = document.getElementById("chatHistory");
        var historyItem = document.createElement("li");
        historyItem.classList.add("history-item");
        historyItem.id = `chat-${currentChatId}`;
        
        var timestamp = new Date().toLocaleString();
        historyItem.textContent = `Chat from ${timestamp}`;
        
        historyItem.onclick = function() {
          displayChatContent(currentChatId);
        };
        
        chatHistory.insertBefore(historyItem, chatHistory.firstChild);
      }

      function updateChatHistoryEntry() {
        var historyItem = document.getElementById(`chat-${currentChatId}`);
        if (historyItem && chatHistories[currentChatId]) {
          historyItem.textContent = `Chat from ${new Date().toLocaleString()} (${chatHistories[currentChatId].length} messages)`;
        }
      }

      function displayChatContent(chatId) {
        // Clear current chat display
        document.getElementById("messages").innerHTML = '';
        
        // Display the selected chat content
        if (chatHistories[chatId]) {
          chatHistories[chatId].forEach(msg => {
            addMessageToDisplay(msg.content, msg.type);
          });
        }
        
        // Update the current chat ID
        currentChatId = chatId;
      }

      function startNewChat() {
        document.getElementById("messages").innerHTML = '';
        currentChatId = Date.now();
        chatHistories[currentChatId] = [];
        createNewChatHistoryEntry();
        document.getElementById("messageText").value = '';
        ws.send("new_chat:" + currentChatId);
        addMessageToDisplay("New chat started. How can I help you?", "received");
      }
          
      function uploadFile() {
        var formData = new FormData(document.getElementById("uploadForm"));
        fetch("/upload/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
            var uploadedFilename = data.info.split("'")[1];
            ws.send("uploaded:" + uploadedFilename);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function saveCurrentChat() {
        var messages = document.getElementById("messages");
        var chatContent = Array.from(messages.children).map(msg => {
          return `${msg.classList.contains('sent') ? 'User' : 'Bot'}: ${msg.textContent}`;
        }).join('\n');

        var chatHistory = document.getElementById("chatHistory");
        var historyItem = document.createElement("li");
        historyItem.classList.add("history-item");
        
        // Create a timestamp for the chat
        var timestamp = new Date().toLocaleString();
        
        historyItem.textContent = `Chat from ${timestamp}`;
        historyItem.onclick = function() {
          // Display the full chat content when clicked
          alert(chatContent);
        };
        chatHistory.appendChild(historyItem);

        // Clear the current chat after saving
        messages.innerHTML = '';
      }

      function initializeChat() {
        if (!currentChatId) {
          startNewChat();
        }
      }
    </script>
  </body>
</html>
